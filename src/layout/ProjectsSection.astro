---
export interface Props {
    projects: {
        id: string;
        title: string;
        description: string;
        image: string;
        alt: string;
        technologies: string[];
        demoUrl?: string;
        repoUrl?: string;
    }[];
}

const { projects } = Astro.props;
const projectsJson = JSON.stringify(projects);
---

<section id="proyectos" class="projects-section" aria-labelledby="projects-title">
    <div class="container">
        <h2 id="projects-title" class="section-title">Mis Proyectos</h2>
        <p class="section-description">Explora algunos de mis trabajos más destacados</p>
        
        <div class="carousel-container" role="region" aria-label="Carrusel de proyectos">
            <div class="projects-carousel" id="projects-carousel"></div>

            <button 
                class="carousel-btn carousel-prev" 
                id="prev-btn"
                aria-label="Proyecto anterior"
            >
                <span>‹</span>
            </button>
            <button 
                class="carousel-btn carousel-next" 
                id="next-btn"
                aria-label="Siguiente proyecto"
            >
                <span>›</span>
            </button>
        </div>

                <div class="carousel-indicators" role="tablist" aria-label="Indicadores de proyectos">
            <!-- Se poblará dinámicamente -->
        </div>

        <!-- Datos serializados para el módulo del carrusel -->
        <script type="application/json" id="projects-data" set:html={projectsJson}></script>

        <!-- Lógica del carrusel -->
        <script is:inline>
            (function () {
              function getProjectsData() {
                const el = document.getElementById('projects-data');
                console.log('Element found:', el);
                if (!el) {
                  console.error('projects-data element not found!');
                  return [];
                }
                try {
                  const data = JSON.parse(el.textContent || '[]');
                  console.log('Projects data parsed:', data);
                  return data;
                } catch (e) {
                  console.error('Error parsing projects data', e);
                  return [];
                }
              }

              function getPerPage() {
                const width = window.innerWidth;
                if (width >= 1024) return 6;
                if (width >= 768) return 4;
                return 2;
              }

              function renderCard(p) {
                const techs = (p.technologies || []).map(t => `<span class="tech-tag" itemprop="keywords">${t}</span>`).join('');
                const demo = p.demoUrl ? `<a href="${p.demoUrl}" target="_blank" rel="noopener noreferrer" aria-label="Ver demo de ${p.title}">Ver Demo</a>` : '';
                const repo = p.repoUrl ? `<a href="${p.repoUrl}" target="_blank" rel="noopener noreferrer" aria-label="Ver código de ${p.title}">Ver Código</a>` : '';
                return `
                  <article class="project-card flip-card" itemscope itemtype="https://schema.org/CreativeWork" role="button" tabindex="0" aria-pressed="false" aria-label="Ver detalles de ${p.title}">
                    <div class="flip-card-inner">
                      <div class="flip-card-front">
                        <div class="project-image">
                          <img src="${p.image}" alt="${p.alt}" loading="lazy" itemprop="image" />
                        </div>
                        <div class="project-content">
                          <h3 class="project-title" itemprop="name">${p.title}</h3>
                          <p class="project-description" itemprop="description">${p.description}</p>
                          <div class="project-technologies">${techs}</div>
                        </div>
                      </div>
                      <div class="flip-card-back">
                        <div class="project-back-content">
                          <h3 class="project-title-back">${p.title}</h3>
                          <p class="project-description-back">${p.description}</p>
                          <div class="project-technologies-back">${techs}</div>
                          <div class="project-links-back">${demo}${repo}</div>
                        </div>
                      </div>
                    </div>
                  </article>
                `;
              }

              function debounce(fn, wait) {
                let t;
                return function(...args) {
                  if (t) window.clearTimeout(t);
                  t = window.setTimeout(() => fn(...args), wait);
                };
              }

              class ProjectCarousel {
                constructor(projects) {
                  this.projects = projects || [];
                  this.carousel = document.getElementById('projects-carousel');
                  this.prevBtn = document.getElementById('prev-btn');
                  this.nextBtn = document.getElementById('next-btn');
                  this.indicatorsWrap = document.querySelector('.carousel-indicators');
                  this.currentIndex = 0;
                  this.totalSlides = 0;
                  this.autoplayInterval = null;
                  this.autoplayDelay = 5000; // 5 segundos
                  this.handleResize = debounce(() => this.buildSlides(), 150);
                  
                  // Touch/Swipe variables
                  this.touchStartX = 0;
                  this.touchEndX = 0;
                  this.touchStartY = 0;
                  this.touchEndY = 0;
                  this.minSwipeDistance = 50; // mínimo de píxeles para considerar un swipe
                  
                  this.init();
                }

                buildSlides() {
                  const perPage = getPerPage();
                  const groups = [];
                  for (let i = 0; i < this.projects.length; i += perPage) {
                    groups.push(this.projects.slice(i, i + perPage));
                  }

                  if (!this.carousel) {
                    console.error('Carousel container not found!');
                    return;
                  }
                  
                  console.log('Building slides with', groups.length, 'groups');
                  this.carousel.innerHTML = groups.map((group, slideIndex) => `
                    <div class="carousel-slide" data-slide-index="${slideIndex}">
                      <div class="slide-grid">
                        ${group.map((p) => renderCard(p)).join('')}
                      </div>
                    </div>
                  `).join('');

                  this.totalSlides = groups.length;
                  if (this.indicatorsWrap) {
                    this.indicatorsWrap.innerHTML = groups.map((_, idx) => `
                      <button class="indicator ${idx === 0 ? 'active' : ''}" data-slide="${idx}" role="tab" aria-label="Ir al grupo ${idx + 1}"></button>
                    `).join('');
                    const indicators = this.indicatorsWrap.querySelectorAll('.indicator');
                    indicators.forEach((indicator, index) => {
                      indicator.addEventListener('click', () => this.goToSlide(index));
                    });
                  }

                  if (this.currentIndex >= this.totalSlides) this.currentIndex = 0;
                  this.updateCarousel();
                  this.attachFlipHandlers();
                  this.equalizeHeights();

                  // Recalcular cuando carguen imágenes
                  if (this.carousel) {
                    const imgs = this.carousel.querySelectorAll('img');
                    imgs.forEach((img) => {
                      if (img.complete) return;
                      img.addEventListener('load', () => this.equalizeHeights(), { once: true });
                    });
                  }
                }

                updateCarousel() {
                  if (this.carousel) {
                    const offset = -(this.currentIndex * 100);
                    this.carousel.style.transform = `translateX(${offset}%)`;
                  }
                  if (this.indicatorsWrap) {
                    const indicators = this.indicatorsWrap.querySelectorAll('.indicator');
                    indicators.forEach((el, idx) => el.classList.toggle('active', idx === this.currentIndex));
                  }
                }

                prevSlide() {
                  this.currentIndex = this.currentIndex === 0 ? this.totalSlides - 1 : this.currentIndex - 1;
                  this.unflipAll();
                  this.updateCarousel();
                  this.resetAutoplay();
                }

                nextSlide() {
                  this.currentIndex = this.currentIndex === this.totalSlides - 1 ? 0 : this.currentIndex + 1;
                  this.unflipAll();
                  this.updateCarousel();
                  this.resetAutoplay();
                }

                goToSlide(index) {
                  this.currentIndex = index;
                  this.unflipAll();
                  this.updateCarousel();
                  this.resetAutoplay();
                }

                equalizeHeights() {
                  if (!this.carousel) return;
                  const slides = this.carousel.querySelectorAll('.carousel-slide');
                  slides.forEach((slide) => {
                    const inners = slide.querySelectorAll('.flip-card-inner');
                    // Reset previous inline heights
                    inners.forEach((el) => (el.style.height = ''));
                    let maxH = 0;
                    inners.forEach((el) => {
                      const h = el.getBoundingClientRect().height;
                      if (h > maxH) maxH = h;
                    });
                    if (maxH > 0) {
                      inners.forEach((el) => (el.style.height = maxH + 'px'));
                    }
                  });
                }

                attachFlipHandlers() {
                  const cards = this.carousel ? this.carousel.querySelectorAll('.flip-card') : [];
                  cards.forEach((card) => {
                    // Hover to flip
                    card.addEventListener('mouseenter', () => {
                      card.classList.add('is-flipped');
                      card.setAttribute('aria-pressed', 'true');
                      this.stopAutoplay();
                    });

                    card.addEventListener('mouseleave', () => {
                      card.classList.remove('is-flipped');
                      card.setAttribute('aria-pressed', 'false');
                      this.resetAutoplay();
                    });

                    // Keyboard accessibility: Enter or Space to toggle
                    card.addEventListener('keydown', (e) => {
                      if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const isFlipped = card.classList.toggle('is-flipped');
                        card.setAttribute('aria-pressed', isFlipped ? 'true' : 'false');
                      }
                    });
                  });
                }

                unflipAll() {
                  if (!this.carousel) return;
                  this.carousel.querySelectorAll('.flip-card.is-flipped').forEach((el) => {
                    el.classList.remove('is-flipped');
                    el.setAttribute('aria-pressed', 'false');
                  });
                }

                startAutoplay() {
                  this.stopAutoplay();
                  this.autoplayInterval = setInterval(() => {
                    this.nextSlide();
                  }, this.autoplayDelay);
                }

                stopAutoplay() {
                  if (this.autoplayInterval) {
                    clearInterval(this.autoplayInterval);
                    this.autoplayInterval = null;
                  }
                }

                resetAutoplay() {
                  this.stopAutoplay();
                  this.startAutoplay();
                }

                handleTouchStart(e) {
                  this.touchStartX = e.touches[0].clientX;
                  this.touchStartY = e.touches[0].clientY;
                  this.stopAutoplay();
                }

                handleTouchMove(e) {
                  this.touchEndX = e.touches[0].clientX;
                  this.touchEndY = e.touches[0].clientY;
                }

                handleTouchEnd() {
                  const diffX = this.touchStartX - this.touchEndX;
                  const diffY = this.touchStartY - this.touchEndY;
                  
                  // Solo hacer swipe si el movimiento horizontal es mayor que el vertical
                  // (para no interferir con el scroll vertical)
                  if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > this.minSwipeDistance) {
                    if (diffX > 0) {
                      // Swipe hacia la izquierda -> siguiente
                      this.nextSlide();
                    } else {
                      // Swipe hacia la derecha -> anterior
                      this.prevSlide();
                    }
                  } else {
                    // Si no hubo swipe, reanudar autoplay
                    this.startAutoplay();
                  }
                  
                  // Reset
                  this.touchStartX = 0;
                  this.touchEndX = 0;
                  this.touchStartY = 0;
                  this.touchEndY = 0;
                }

                init() {
                  console.log('Initializing carousel with', this.projects.length, 'projects');
                  this.prevBtn && this.prevBtn.addEventListener('click', () => this.prevSlide());
                  this.nextBtn && this.nextBtn.addEventListener('click', () => this.nextSlide());
                  window.addEventListener('resize', this.handleResize);
                  
                  // Pausar autoplay al hacer hover
                  if (this.carousel) {
                    this.carousel.addEventListener('mouseenter', () => this.stopAutoplay());
                    this.carousel.addEventListener('mouseleave', () => this.startAutoplay());
                    
                    // Touch events para swipe en móviles
                    this.carousel.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
                    this.carousel.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: true });
                    this.carousel.addEventListener('touchend', () => this.handleTouchEnd());
                  }
                  
                  this.buildSlides();
                  this.startAutoplay();
                }
              }

              document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM loaded, initializing carousel...');
                const data = getProjectsData();
                new ProjectCarousel(data);
              });
            })();
        </script>

    </div>
</section>

<style>
    .projects-section {
        padding: 4rem 0;
        background: var(--bg-color, #f8f9fa);
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .section-title {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 1rem;
        color: var(--text-color, #333);
    }

    .section-description {
        text-align: center;
        margin-bottom: 3rem;
        color: var(--text-secondary, #666);
        font-size: 1.1rem;
    }

  .carousel-container {
    position: relative;
    /* Volvemos a ocultar overflow para que el slide se vea limpio */
    overflow: hidden;
    border-radius: 12px;
    box-sizing: border-box;
    /* Creamos gutters laterales para alejar los botones del contenido */
    padding-left: 1rem;
    padding-right: 1rem;
  }

  .projects-carousel {
    display: flex;
    transition: transform 0.4s ease;
    will-change: transform;
  }

    /* Estilos globales para contenido generado dinámicamente */
  :global(.carousel-slide) {
    flex: 0 0 100%;
    /* Agregamos padding horizontal para separar visualmente entre slides durante la transición */
    padding: 1rem 1.5rem;
    /* Evita que sombras o contenido del slide vecino se filtren */
    overflow: hidden;
  }

    :global(.slide-grid) {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

  :global(.project-card) {
        background: transparent; /* el contenedor no rota */
        border-radius: 12px;
        overflow: visible;
        box-shadow: none; /* la sombra va en el interior que rota */
        transition: transform 0.3s ease;
    /* Usamos el gap del grid y el padding del contenedor para el espaciado */
    margin: 0;
    }

  :global(.project-card:hover) {
    /* evitamos conflicto con flip */
    transform: none;
  }

    :global(.project-image) {
        position: relative;
        aspect-ratio: 16/10;
        overflow: hidden;
    }

    :global(.project-image img) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    :global(.project-overlay) {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    :global(.project-card:hover .project-overlay) {
        opacity: 1;
    }

    :global(.project-links) {
        display: flex;
        gap: 1rem;
    }

    :global(.project-links a) {
        padding: 0.5rem 1rem;
        background: var(--accent-color, #007bff);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        transition: background 0.3s ease;
    }

    :global(.project-links a:hover) {
        background: var(--accent-hover, #0056b3);
    }

    :global(.project-content) {
        padding: 1.5rem;
    }

  /* Flip card effect */
  :global(.flip-card) {
    perspective: 1000px;
    cursor: pointer;
  }

  :global(.flip-card-inner) {
    position: relative;
    transition: transform 0.6s ease;
    transform-style: preserve-3d;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  :global(.flip-card.is-flipped .flip-card-inner) {
    transform: rotateY(180deg);
  }

  :global(.flip-card-front),
  :global(.flip-card-back) {
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border-radius: 12px;
    overflow: hidden;
  }

  :global(.flip-card-front) {
    background: white;
    position: relative;
  }

  :global(.flip-card-back) {
    transform: rotateY(180deg);
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%); /* gradiente azul */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  :global(.project-back-content) {
    text-align: center;
    color: white;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 100%;
  }

  :global(.project-title-back) {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
    color: white;
  }

  :global(.project-description-back) {
    font-size: 0.95rem;
    line-height: 1.6;
    margin: 0;
    color: rgba(255, 255, 255, 0.95);
  }

  :global(.project-technologies-back) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }

  :global(.project-technologies-back .tech-tag) {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  :global(.project-links-back) {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 0.5rem;
  }

  :global(.project-links-back a) {
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    font-weight: 500;
  }

  :global(.project-links-back a:hover) {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  /* profundidad al pasar el mouse */
  :global(.flip-card:hover .flip-card-inner) {
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
  }

    :global(.project-title) {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-color, #333);
    }

    :global(.project-description) {
        color: var(--text-secondary, #666);
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    :global(.project-technologies) {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    :global(.tech-tag) {
        padding: 0.25rem 0.75rem;
        background: var(--tag-bg, #e9ecef);
        color: var(--tag-color, #495057);
        border-radius: 20px;
        font-size: 0.875rem;
    }

    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(29, 78, 216, 0.8);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.3s ease;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .carousel-btn span {
        font-size: 2rem;
        line-height: 1;
        display: block;
        margin-top: -6px;
    }

    .carousel-btn:hover {
        background: rgba(29, 78, 216, 1);
    }

  .carousel-prev { left: 0.25rem; }
  .carousel-next { right: 0.25rem; }

    .carousel-indicators {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    :global(.indicator) {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        background: #ccc;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    :global(.indicator.active) { 
        background: var(--accent-color, #007bff); 
    }

    @media (min-width: 768px) {
        :global(.slide-grid) { grid-template-columns: repeat(2, 1fr); }
    /* Más espacio lateral para botones en tablets */
    .carousel-container { padding-left: 1.5rem; padding-right: 1.5rem; }
    .carousel-prev { left: 0; }
    .carousel-next { right: 0; }
  :global(.carousel-slide) { padding: 1rem 1.75rem; }
    }

    @media (min-width: 1024px) {
        :global(.slide-grid) { grid-template-columns: repeat(3, 1fr); }
    /* En desktop, ampliar gutters para que queden más "afuera" pero sin cortar el slide */
    .carousel-container { padding-left: 2rem; padding-right: 2rem; }
    .carousel-prev { left: 0; }
    .carousel-next { right: 0; }
  :global(.carousel-slide) { padding: 1rem 2rem; }
    }

    /* Responsiveness para pantallas chicas */
    @media (max-width: 640px) {
        :global(.slide-grid) { gap: 1rem; }
        :global(.project-card) { margin: 0 0.5rem; }
        .carousel-btn { width: 40px; height: 40px; }
        .carousel-btn span { font-size: 1.75rem; margin-top: -4px; }
    }

    @media (max-width: 360px) {
        :global(.project-card) { margin: 0 0.25rem; }
        .carousel-btn { width: 36px; height: 36px; }
        .carousel-btn span { font-size: 1.5rem; margin-top: -2px; }
    }
</style>

